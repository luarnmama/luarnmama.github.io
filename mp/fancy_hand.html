<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sci-Fi Hand Tracking Holographic Dial</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.4/p5.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.4/addons/p5.sound.min.js"></script>
    <script src="https://unpkg.com/ml5@1/dist/ml5.min.js"></script>

    <style>
      html, body {
        margin: 0;
        padding: 0;
        background-color: #0a0f19;
        overflow: hidden;
        font-family: 'Courier New', Courier, monospace;
      }

      /* 回上頁按鈕 */
      #back-btn {
        position: fixed;
        top: 20px;
        left: 20px;
        z-index: 2000;
        padding: 10px 20px;
        font-size: 0.9em;
        background: rgba(0, 255, 255, 0.1);
        border: 1px solid rgba(0, 255, 255, 0.3);
        backdrop-filter: blur(10px);
        border-radius: 5px;
        color: #0ff;
        text-decoration: none;
        transition: all 0.3s;
        text-transform: uppercase;
        letter-spacing: 2px;
      }

      #back-btn:hover {
        background: rgba(0, 255, 255, 0.2);
        box-shadow: 0 0 15px rgba(0, 255, 255, 0.5);
      }

      /* 啟動介面 */
      #overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(circle, #1a1f35 0%, #0a0f19 100%);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        color: #0ff;
        text-align: center;
      }

      .start-btn {
        background: transparent;
        border: 1px solid #0ff;
        color: #0ff;
        padding: 15px 40px;
        font-size: 1.2em;
        cursor: pointer;
        margin-top: 30px;
        letter-spacing: 5px;
        transition: all 0.3s;
        box-shadow: 0 0 10px rgba(0, 255, 255, 0.2);
      }

      .start-btn:hover {
        background: #0ff;
        color: #0a0f19;
        box-shadow: 0 0 30px rgba(0, 255, 255, 0.8);
      }

      canvas {
        display: block;
        margin: 0 auto;
      }
    </style>
  </head>
  <body>
    <a href="../perception_demo.html" id="back-btn">< EXIT SYSTEM</a>

    <div id="overlay">
      <div style="font-size: 20px; letter-spacing: 10px; margin-bottom: 20px;">HOLOGRAPHIC INTERFACE</div>
      <h1 style="font-weight: 300; margin-bottom: 0;">FANCY HAND V2</h1>
      <p style="color: rgba(0, 255, 255, 0.5); margin-top: 10px;">AUTHORIZED ACCESS ONLY</p>
      <button class="start-btn" onclick="initSystem()">INITIALIZE</button>
    </div>

    <script>
      let video;
      let handPose;
      let hands = [];
      let isReady = false;

      // 平滑變數
      let smoothedAngle = 0; 
      let smoothedX = 0;
      let smoothedY = 0;

      function setup() {
        createCanvas(windowWidth, windowHeight);
        textFont('Courier New');
        angleMode(DEGREES);
        
        // 預載入模型，但不啟動偵測
        handPose = ml5.handPose({ flipped: true });
      }

      async function initSystem() {
        // 請求相機權限
        video = createCapture(VIDEO, () => {
          document.getElementById('overlay').style.fadeOut;
          document.getElementById('overlay').style.display = 'none';
          isReady = true;
          // 確定相機啟動後才開始偵測，避免 estimateHands 讀取到 null
          handPose.detectStart(video, gotHands);
        });
        video.size(640, 480);
        video.hide();
      }

      function gotHands(results) {
        hands = results;
      }

      function draw() {
        background(10, 15, 25);
        
        if (!isReady) return;

        // 影像背景 (科幻藍調)
        push();
        translate(width, 0);
        scale(-1, 1);
        tint(0, 200, 255, 40); 
        // 居中顯示影像
        let vW = width;
        let vH = (video.height / video.width) * width;
        image(video, 0, (height - vH)/2, vW, vH);
        pop();

        if (hands.length > 0) {
          let hand = hands[0];
          drawSciFiSkeleton(hand);
          drawFingertips(hand);
          drawHoloDial(hand);
        } else {
          drawScanningUI();
        }
      }

      function drawHoloDial(hand) {
        let wrist = hand.keypoints[0];
        let middle = hand.keypoints[9];
        
        // 座標轉換 (適應視窗縮放)
        let targetX = map(wrist.x, 0, 640, 0, width);
        let targetY = map(wrist.y, 0, 480, 0, height);
        
        let angle = atan2(middle.y - wrist.y, middle.x - wrist.x) + 90;
        
        smoothedAngle = lerp(smoothedAngle, angle, 0.1); 
        smoothedX = lerp(smoothedX, targetX, 0.2);
        smoothedY = lerp(smoothedY, targetY, 0.2);
        
        push();
        translate(smoothedX, smoothedY);
        
        // 裝飾環
        noFill();
        stroke(0, 255, 255, 80);
        drawingContext.setLineDash([5, 10]);
        circle(0, 0, 160);
        drawingContext.setLineDash([]);
        
        rotate(smoothedAngle);
        
        // 主撥盤
        stroke(0, 255, 255);
        strokeWeight(2);
        arc(0, 0, 120, 120, 30, 330);
        
        for(let i = 0; i < 8; i++) {
          rotate(45);
          line(50, 0, 60, 0);
        }
        
        // 指針
        fill(255, 0, 100);
        noStroke();
        triangle(75, 0, 65, -5, 65, 5);
        
        pop();

        // 數據標籤
        fill(0, 255, 255);
        textSize(16);
        textAlign(CENTER);
        text(`POS_X:${int(smoothedX)}`, targetX, targetY + 100);
        text(`ROT:${int(smoothedAngle)}°`, targetX, targetY + 120);
      }

      function drawSciFiSkeleton(hand) {
        stroke(0, 255, 255, 120);
        strokeWeight(1);
        let connections = handPose.getConnections();
        for (let i = 0; i < connections.length; i++) {
          let a = connections[i][0];
          let b = connections[i][1];
          let x1 = map(hand.keypoints[a].x, 0, 640, 0, width);
          let y1 = map(hand.keypoints[a].y, 0, 480, 0, height);
          let x2 = map(hand.keypoints[b].x, 0, 640, 0, width);
          let y2 = map(hand.keypoints[b].y, 0, 480, 0, height);
          line(x1, y1, x2, y2);
        }
      }

      function drawFingertips(hand) {
        let tips = [4, 8, 12, 16, 20];
        for (let i of tips) {
          let k = hand.keypoints[i];
          let x = map(k.x, 0, 640, 0, width);
          let y = map(k.y, 0, 480, 0, height);
          
          let pulse = map(sin(frameCount * 10), -1, 1, 0.5, 1.5);
          noFill();
          stroke(255, 255, 255, 150);
          circle(x, y, 10 + pulse * 5);
          fill(0, 255, 255);
          circle(x, y, 3);
        }
      }

      function drawScanningUI() {
        stroke(0, 255, 255, 50);
        let scanY = (frameCount * 5) % height;
        line(0, scanY, width, scanY);
        
        fill(0, 255, 255, 150);
        noStroke();
        textAlign(CENTER);
        text(">>> SCANNING FOR BIOMETRIC DATA <<<", width/2, height/2);
      }

      function windowResized() {
        resizeCanvas(windowWidth, windowHeight);
      }
    </script>
  </body>
</html>
