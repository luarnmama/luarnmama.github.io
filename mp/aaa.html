<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sci-Fi Hand Tracking - Virtual Interface</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.4/p5.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.4/addons/p5.sound.min.js"></script>
    <script src="https://unpkg.com/ml5@1/dist/ml5.min.js"></script>

    <style>
      html, body { margin: 0; padding: 0; background-color: #0a0f19; overflow: hidden; font-family: 'Courier New', monospace; }
      #back-btn { position: fixed; top: 20px; left: 20px; z-index: 2000; padding: 10px 20px; font-size: 0.9em; background: rgba(0, 255, 255, 0.1); border: 1px solid rgba(0, 255, 255, 0.3); backdrop-filter: blur(10px); border-radius: 5px; color: #0ff; text-decoration: none; text-transform: uppercase; letter-spacing: 2px; }
      #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle, #1a1f35 0%, #0a0f19 100%); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 1000; color: #0ff; }
      .start-btn { background: transparent; border: 1px solid #0ff; color: #0ff; padding: 15px 40px; font-size: 1.2em; cursor: pointer; margin-top: 30px; letter-spacing: 5px; }
      canvas { display: block; }
    </style>
  </head>
  <body>
    <a href="../perception_demo.html" id="back-btn">< EXIT SYSTEM</a>

    <div id="overlay">
      <div style="letter-spacing: 10px; margin-bottom: 20px;">VIRTUAL INTERFACE</div>
      <button class="start-btn" onclick="initSystem()">INITIALIZE</button>
    </div>

    <script>
      let video, handPose, hands = [];
      let isReady = false;
      let smoothedAngle = 0, smoothedX = 0, smoothedY = 0;
      
      // 系統狀態
      let mainColor;
      let colors = ['#00ffff', '#ff00ff', '#ffff00']; // 青、洋紅、黃
      let colorIdx = 0;
      let glitchTimer = 0;

      // 按鈕定義
      let buttons = [
        { label: 'COLOR', x: 50, y: 150, w: 100, h: 50, active: false },
        { label: 'GLITCH', x: 50, y: 220, w: 100, h: 50, active: false },
        { label: 'EXIT', x: 50, y: 290, w: 100, h: 50, active: false }
      ];

      function setup() {
        createCanvas(windowWidth, windowHeight);
        mainColor = color(colors[colorIdx]);
        handPose = ml5.handPose({ flipped: true });
      }

      function initSystem() {
        video = createCapture(VIDEO, () => {
          document.getElementById('overlay').style.display = 'none';
          isReady = true;
          handPose.detectStart(video, results => hands = results);
        });
        video.size(640, 480);
        video.hide();
      }

      function draw() {
        background(10, 15, 25);
        if (!isReady) return;

        // 處理 Glitch 特效
        let offsetX = 0;
        if (glitchTimer > 0) {
          offsetX = random(-10, 10);
          glitchTimer--;
        }

        // 繪製背景影像
        push();
        translate(width + offsetX, 0);
        scale(-1, 1);
        tint(red(mainColor), green(mainColor), blue(mainColor), 40);
        image(video, 0, 0, width, height, 0, 0, video.width, video.height, COVER);
        pop();

        if (hands.length > 0) {
          let hand = hands[0];
          let indexTip = hand.keypoints[8];
          let tx = map(indexTip.x, 0, 640, 0, width);
          let ty = map(indexTip.y, 0, 480, 0, height);

          checkButtons(tx, ty); // 偵測碰撞
          drawVirtualButtons();
          drawSciFiSkeleton(hand);
          drawHoloDial(hand);
          
          // 畫出滑鼠指標 (指尖)
          fill(255);
          noStroke();
          circle(tx, ty, 10);
          noFill();
          stroke(mainColor);
          circle(tx, ty, 20 + sin(frameCount*0.2)*5);
        } else {
          drawScanningUI();
        }
      }

      function drawVirtualButtons() {
        buttons.forEach(btn => {
          push();
          translate(btn.x, btn.y);
          
          // 按鈕外框
          noFill();
          stroke(mainColor);
          strokeWeight(btn.active ? 3 : 1);
          rect(0, 0, btn.w, btn.h, 5);
          
          // 啟用時的發光填充
          if (btn.active) {
            fill(red(mainColor), green(mainColor), blue(mainColor), 100);
            rect(5, 5, btn.w - 10, btn.h - 10);
            // 掃描線效果
            strokeWeight(1);
            line(0, (frameCount*2)%btn.h, btn.w, (frameCount*2)%btn.h);
          }
          
          // 文字
          fill(btn.active ? 255 : mainColor);
          noStroke();
          textAlign(CENTER, CENTER);
          textSize(14);
          text(btn.label, btn.w/2, btn.h/2);
          pop();
        });
      }

      function checkButtons(x, y) {
        buttons.forEach(btn => {
          let isInside = x > btn.x && x < btn.x + btn.w && y > btn.y && y < btn.y + btn.h;
          
          if (isInside && !btn.active) {
            btn.active = true;
            triggerAction(btn.label);
          } else if (!isInside) {
            btn.active = false;
          }
        });
      }

      function triggerAction(label) {
        if (label === 'COLOR') {
          colorIdx = (colorIdx + 1) % colors.length;
          mainColor = color(colors[colorIdx]);
        } else if (label === 'GLITCH') {
          glitchTimer = 30;
        } else if (label === 'EXIT') {
          window.location.href = '../perception_demo.html';
        }
      }

      // --- 以下為原本的特效邏輯 (改用動態 mainColor) ---

      function drawHoloDial(hand) {
        let wrist = hand.keypoints[0], middle = hand.keypoints[9];
        let targetX = map(wrist.x, 0, 640, 0, width);
        let targetY = map(wrist.y, 0, 480, 0, height);
        let angle = atan2(middle.y - wrist.y, middle.x - wrist.x) + 90;
        
        smoothedAngle = lerp(smoothedAngle, angle, 0.1); 
        smoothedX = lerp(smoothedX, targetX, 0.2);
        smoothedY = lerp(smoothedY, targetY, 0.2);
        
        push();
        translate(smoothedX, smoothedY);
        noFill();
        stroke(red(mainColor), green(mainColor), blue(mainColor), 100);
        drawingContext.setLineDash([5, 10]);
        circle(0, 0, 160);
        drawingContext.setLineDash([]);
        rotate(smoothedAngle);
        stroke(mainColor);
        strokeWeight(2);
        arc(0, 0, 120, 120, 30, 330);
        pop();
      }

      function drawSciFiSkeleton(hand) {
        stroke(red(mainColor), green(mainColor), blue(mainColor), 120);
        strokeWeight(1);
        let connections = handPose.getConnections();
        for (let i = 0; i < connections.length; i++) {
          let a = connections[i][0], b = connections[i][1];
          let x1 = map(hand.keypoints[a].x, 0, 640, 0, width);
          let y1 = map(hand.keypoints[a].y, 0, 480, 0, height);
          let x2 = map(hand.keypoints[b].x, 0, 640, 0, width);
          let y2 = map(hand.keypoints[b].y, 0, 480, 0, height);
          line(x1, y1, x2, y2);
        }
      }

      function drawScanningUI() {
        stroke(mainColor);
        line(0, (frameCount * 5) % height, width, (frameCount * 5) % height);
        fill(mainColor);
        textAlign(CENTER);
        text("SYSTEM SCANNING...", width/2, height/2);
      }

      function windowResized() { resizeCanvas(windowWidth, windowHeight); }
    </script>
  </body>
</html>